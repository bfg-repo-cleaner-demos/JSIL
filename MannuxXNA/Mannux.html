<!DOCTYPE html> 
<html>
  <head>
    <title>Mannux</title>
    <link rel="stylesheet" href="mannux.css">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
  </head>
  <body onload="onLoad()">
    <script src="../Libraries/JSIL.Core.js" type="text/javascript"></script>
    <script src="../Libraries/JSIL.Bootstrap.js" type="text/javascript"></script>
    
    <!-- workaround for chromium bug -->
    <div id="scripts" style="display: none"></div>
    <div id="images" style="display: none"></div>
    
    <canvas id="canvas" width="640" height="480"></canvas><br>
    <button id="quitButton" title="Quit Game">X</button>
    <button id="loadButton">Load Mannux</button>
    <div id="loadingProgress">
      <div id="progressBar"></div>
    </div>
    <textarea id="log"></textarea>
    
    <script type="text/javascript">    
    JSIL.Host.getCanvas = function (desiredWidth, desiredHeight) {
        var e = document.getElementById("canvas");
        if (typeof (desiredWidth) === "number")
          e.width = desiredWidth;
        if (typeof (desiredHeight) === "number")
          e.height = desiredHeight;
        
        return e;
    };
    JSIL.Host.createCanvas = function (desiredWidth, desiredHeight) {
        var e = document.createElement("canvas");
        e.width = desiredWidth;
        e.height = desiredHeight;
        document.getElementById("images").appendChild(e);
        
        return e;
    };
    JSIL.Host.logWrite = function (text) {
        document.getElementById("log").value += text;
    };
    JSIL.Host.logWriteLine = function (text) {
        document.getElementById("log").value += text + "\n";
    };
    JSIL.Host.getFile = function (filename) {
      var key = getShortName(filename);
      if (!allFiles.hasOwnProperty(key))
        throw new System.Exception("The file '" + key + "' is not in the asset manifest.");
      return allFiles[key];
    };
    JSIL.Host.getImage = function (filename) {
      var key = getShortName(filename);
      if (!allImages.hasOwnProperty(key))
        throw new System.Exception("The image '" + key + "' is not in the asset manifest.");
      return allImages[key];
    };
    JSIL.Host.getAsset = function (filename) {
      if (!allAssets.hasOwnProperty(filename))
        throw new System.Exception("The asset '" + filename + "' is not in the asset manifest.");
      return allAssets[filename];
    };
    JSIL.Host.getHeldKeys = function () {
      return Array.prototype.slice.call(heldKeys);
    };
    JSIL.Host.getMousePosition = function () {
      return Array.prototype.slice.call(mousePosition);
    };
    JSIL.Host.getHeldButtons = function () {
      return Array.prototype.slice.call(heldButtons);
    };
    
    var allFiles = {};
    var allImages = {};
    var allAssets = {};
    var heldKeys = [];
    var heldButtons = [];
    var mousePosition = [0, 0];
    
    window.addEventListener(
      "keydown", function (evt) {
        if (Array.prototype.indexOf.call(heldKeys, evt.keyCode) === -1)
          heldKeys.push(evt.keyCode);        
      }, true
    );
    
    window.addEventListener(
      "keyup", function (evt) {
        var keyCode = evt.keyCode;
        heldKeys = heldKeys.filter(function (element, index, array) {
          return element != keyCode;
        });
      }, true
    );
    
    window.addEventListener(
      "mousemove", function (evt) {
        var canvas = document.getElementById("canvas");
        
        mousePosition[0] = evt.clientX - canvas.offsetLeft;
        mousePosition[1] = evt.clientY - canvas.offsetTop;
      }, true
    );
    
    function getShortName (filename) {
      var lastIndex = filename.lastIndexOf("/");
      if (lastIndex === -1)
        return filename.toLowerCase();
      
      return filename.substr(lastIndex + 1).toLowerCase();
    };
    
    function getAssetName (filename) {
      filename = getShortName(filename);
      var lastIndex = filename.lastIndexOf(".");
      if (lastIndex === -1)
        return filename;
      
      return filename.substr(0, lastIndex);
    };
    
    var assetLoaders = {
      "Script": function loadScript (filename, onError, onDoneLoading) {
        var e = document.createElement("script");
        e.type = "text/javascript";
        e.addEventListener("error", onError, true);
        e.addEventListener("load", onDoneLoading, true);
        e.id = "script_" + filename;
        e.src = filename;
        document.getElementById("scripts").appendChild(e);
      },
      "Image": function loadImage (filename, onError, onDoneLoading) {
        var e = document.createElement("img");
        e.addEventListener("error", onError, true);
        e.addEventListener("load", function () {
          allImages[getShortName(filename)] = e;
          allAssets[getAssetName(filename)] = e;
          onDoneLoading();
        }, true);
        e.id = "image_" + filename;
        e.src = filename;
        document.getElementById("images").appendChild(e);
      },
      "File": function loadBinaryFile (filename, onError, onDoneLoading) {
        var req;
        if (typeof (ActiveXObject) !== "undefined")
          req = new ActiveXObject("MSXML2.XMLHTTP");
        else
          req = new XMLHttpRequest();
        
        req.open('GET', filename, false);
        if (typeof (req.overrideMimeType) !== "undefined")
          req.overrideMimeType('text/plain; charset=x-user-defined');
        
        req.send(null);
        
        if (req.status <= 299) {
          var bytes;
          if (
            (typeof (req.responseBody) !== "undefined") && 
            (typeof (VBArray) !== "undefined")
          ) {
              bytes = new VBArray(req.responseBody).toArray();
          } else {
              var text = req.responseText;
              bytes = new Array(req.responseText.length);
              for (var i = 0, l = text.length; i < l; i++)
                bytes[i] = text.charCodeAt(i) & 0xFF;
          }
          allFiles[getShortName(filename)] = bytes;
          onDoneLoading();
        } else {
          onError();
        }
      }
    };
    
    function loadNextAsset (assets, i, onDoneLoading, loadDelay) {      
      var w = (i * document.getElementById("loadingProgress").clientWidth) / (assets.length + 1);
      document.getElementById("progressBar").style.width = w.toString() + "px";
      
      if (i >= assets.length) {
        setTimeout(onDoneLoading, loadDelay);
        return;
      }
    
      var assetSpec = assets[i];
      var j = i + 1;
      
      var stepCallback = function () {
        loadNextAsset(assets, j, onDoneLoading, loadDelay);
      };
      
      var errorCallback = function (e) {
        JSIL.Host.logWriteLine("The asset '" + assetSpec + "' could not be loaded:" + String(e));
        stepCallback();
      };
      
      var assetType = assetSpec[0];
      var assetPath = assetSpec[1];
      var assetLoader = assetLoaders[assetType];
      
      if (typeof (assetLoader) !== "function") {
        errorCallback("No asset loader registered for type '" + assetType + "'.");
      } else {      
        setTimeout(function () {        
          assetLoader(assetPath, errorCallback, stepCallback);
        }, loadDelay);
      }
    }
    
    function loadAssets (assets, onDoneLoading) {
      loadNextAsset(assets, 0, onDoneLoading, 100);
    }
    
    function beginLoading () {
      document.getElementById("progressBar").style.width = "0px";
      document.getElementById("loadButton").style.display = "none";
      document.getElementById("loadingProgress").style.display = "";
      
      var assetsToLoad = [
        ["Script", "../Libraries/System.Drawing.js"],
        ["Script", "mscorlib, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089.js"],
        ["Script", "System.Xml, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089.js"],
        ["Script", "System.Data.SqlXml, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089.js"],
        ["Script", "System.Configuration, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a.js"],
        ["Script", "System, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089.js"],
        ["Script", "System.Core, Version=3.5.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089.js"],
        ["Script", "System.Drawing, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a.js"],
        ["Script", "System.Windows.Forms, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089.js"],
        ["Script", "Microsoft.Xna.Framework, Version=3.1.0.0, Culture=neutral, PublicKeyToken=6d5c3888ef60e27d.js"],
        ["Script", "Microsoft.Xna.Framework.Game, Version=3.1.0.0, Culture=neutral, PublicKeyToken=6d5c3888ef60e27d.js"],
        ["Script", "../Libraries/System.Windows.js"],
        ["Script", "../Libraries/JSIL.XNA.js"],
        ["Script", "../Libraries/JSIL.IO.js"],
        ["Script", "Mannux, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null.js"],
        ["File", "Content/Mannux.map"],
        ["File", "Content/map00.map"],
        ["File", "Content/map01.map"],
        ["File", "Content/MAP02.map"],
        ["File", "Content/MAP03.map"],
        ["File", "Content/MAP04.map"],
        ["File", "Content/test.map"],
        ["File", "Content/test2.map"],
        ["File", "Content/shaft.map"],
        ["File", "Content/testmap.map"],
        ["Image", "Content/Boom.png"],
        ["Image", "Content/door.png"],
        ["Image", "Content/bullet.png"],
        ["Image", "Content/mantiles.png"],
        ["Image", "Content/ripper.png"],
        ["Image", "Content/tabpis.png"],
        ["File", "Content/boom.txt"],
        ["File", "Content/bullet.txt"],
        ["File", "Content/door.txt"],
        ["File", "Content/ripper.txt"],
        ["File", "Content/tabby.txt"]
      ];
      
      JSIL.Host.logWrite("Loading data ... ");
      loadAssets(assetsToLoad, function () {
        JSIL.Host.logWriteLine("done.");
        try {
          JSIL.Initialize();
          
          document.getElementById("quitButton").style.display = "";
          
          Mannux.Program.Main([]);
          // Main doesn't block since we're using the browser's event loop
        } finally {
          document.getElementById("loadingProgress").style.display = "none";
        }
      });
    }
    
    function quitGame () {
      Microsoft.Xna.Framework.Game.ForceQuit();
      document.getElementById("quitButton").style.display = "none";
    }
    
    function onLoad () {
      document.getElementById("log").value = "";
      document.getElementById("quitButton").style.display = "none";
      document.getElementById("loadingProgress").style.display = "none";
    }
        
    document.getElementById("quitButton").addEventListener(
      "click", quitGame, true
    );
    document.getElementById("loadButton").addEventListener(
      "click", beginLoading, true
    );
    </script>
  </body>
</html>