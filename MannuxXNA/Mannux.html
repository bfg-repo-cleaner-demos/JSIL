<!DOCTYPE html> 
<html>
  <head>
    <title>Mannux</title>
    <link rel="stylesheet" href="mannux.css" />
  </head>
  <body onload="onLoad()">
    <script src="../Libraries/JSIL.Core.js" type="text/javascript"></script>
    <script src="../Libraries/JSIL.Bootstrap.js" type="text/javascript"></script>
    
    <!-- workaround for chromium bug -->
    <div id="scripts"></div>
    
    <canvas id="canvas"></canvas><br>
    <button id="loadButton">Load Mannux</button>
    <div id="loadingProgress" style="display: none">
      <div id="progressBar"></div>
    </div>
    <textarea id="log"></textarea>
    
    <script type="text/javascript">
    JSIL.Host.getCanvas = function (desiredWidth, desiredHeight) {
        return document.getElementById("canvas");
    };
    JSIL.Host.logWrite = function (text) {
        document.getElementById("log").value += text;
    };
    JSIL.Host.logWriteLine = function (text) {
        document.getElementById("log").value += text + "\n";
    };
    
    function loadScript (filename, onError, onDoneLoading) {
      var e = document.createElement("script");
      e.type = "text/javascript";
      e.addEventListener("error", onError, true);
      e.addEventListener("load", onDoneLoading, true);
      e.id = "script_" + filename;
      e.src = filename;
      document.getElementById("scripts").appendChild(e);
    }
    
    function loadNextScript (scripts, i, onDoneLoading, scriptLoadDelay) {      
      var w = (i * document.getElementById("loadingProgress").clientWidth) / scripts.length;
      document.getElementById("progressBar").style.width = w;
      
      if (i >= scripts.length) {
        setTimeout(onDoneLoading, scriptLoadDelay);
        return;
      }
    
      var theScript = scripts[i];
      var j = i + 1;
      
      var stepCallback = function () {
        JSIL.Host.logWriteLine("done.");
        loadNextScript(scripts, j, onDoneLoading, scriptLoadDelay);
      };
      
      var errorCallback = function (e) {
        JSIL.Host.logWriteLine("The script '" + theScript + "' could not be loaded:" + String(e));
        stepCallback();
      };
      
      JSIL.Host.logWrite("Loading script '" + theScript + "' ... ");
      setTimeout(function () {        
        loadScript(theScript, errorCallback, stepCallback);
      }, scriptLoadDelay);
    }
    
    function loadScripts (scripts, onDoneLoading) {
      loadNextScript(scripts, 0, onDoneLoading, 100);
    }
    
    function beginLoading () {
      document.getElementById("loadButton").style.display = "none";
      document.getElementById("loadingProgress").style.display = "block";
      
      var scriptsToLoad = [
        "mscorlib, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089.js",
        "../Libraries/System.Windows.js",
        "../Libraries/System.Drawing.js",
        "Microsoft.Xna.Framework, Version=3.1.0.0, Culture=neutral, PublicKeyToken=6d5c3888ef60e27d.js",
        "Microsoft.Xna.Framework.Game, Version=3.1.0.0, Culture=neutral, PublicKeyToken=6d5c3888ef60e27d.js",
        "../Libraries/JSIL.XNA.js",
        "Mannux, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null.js"
      ];
      
      loadScripts(scriptsToLoad, function () {
        document.getElementById("loadingProgress").style.display = "none";
        try {
          Mannux.Program.Main([]);
        } catch (e) {
          JSIL.Host.error(e, "Error while starting Mannux: ");
        }
      });
    }
    
    function onLoad () {
      document.getElementById("log").value = "";
    }
    
    document.getElementById("loadButton").addEventListener(
      "click", beginLoading, true
    );
    </script>
  </body>
</html>