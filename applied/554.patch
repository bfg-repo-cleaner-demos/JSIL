From dada25b191af811b7886a888d49f7e15a4858770 Mon Sep 17 00:00:00 2001
From: ik <igor@kiselev.spb.ru>
Date: Wed, 9 Jul 2014 22:50:42 -0700
Subject: [PATCH] Delegate/lambda tests added.

---
 .../DelegateRemoveAdvancedWithLambda_Issue541.cs   | 22 ++++++++++++
 .../LambdaInStateMachine1_Issue544.cs              | 42 ++++++++++++++++++++++
 .../LambdaInStateMachine2_Issue544.cs              | 38 ++++++++++++++++++++
 Tests/SimpleTests.csproj                           |  3 ++
 4 files changed, 105 insertions(+)
 create mode 100644 Tests/SimpleTestCases/DelegateRemoveAdvancedWithLambda_Issue541.cs
 create mode 100644 Tests/SimpleTestCases/LambdaInStateMachine1_Issue544.cs
 create mode 100644 Tests/SimpleTestCases/LambdaInStateMachine2_Issue544.cs

diff --git a/Tests/SimpleTestCases/DelegateRemoveAdvancedWithLambda_Issue541.cs b/Tests/SimpleTestCases/DelegateRemoveAdvancedWithLambda_Issue541.cs
new file mode 100644
index 0000000..8f548cd
--- /dev/null
+++ b/Tests/SimpleTestCases/DelegateRemoveAdvancedWithLambda_Issue541.cs
@@ -0,0 +1,22 @@
+using System;
+public static class Program
+{
+    public static void Main(string[] args)
+    {
+	    // See http://confluence.jetbrains.com/display/ReSharper/Delegate+subtraction+has+unpredictable+semantics
+        Action a = () => Console.Write("A");
+        Action b = () => Console.Write("B");
+        Action c = () => Console.Write("C");
+        Action s = a + b + c + Console.WriteLine;
+        s();                  //ABC 
+        (s - a)();            //BC 
+        (s - b)();            //AC 
+        (s - c)();            //AB 
+        (s - (a + b))();      //C 
+        (s - (b + c))();      //A 
+        (s - (a + c))();      //ABC 
+
+        s = a + b + a;
+        (s - a)();            // AB
+    }
+}
\ No newline at end of file
diff --git a/Tests/SimpleTestCases/LambdaInStateMachine1_Issue544.cs b/Tests/SimpleTestCases/LambdaInStateMachine1_Issue544.cs
new file mode 100644
index 0000000..70f206e
--- /dev/null
+++ b/Tests/SimpleTestCases/LambdaInStateMachine1_Issue544.cs
@@ -0,0 +1,42 @@
+using System;
+using System.Collections;
+using System.Threading.Tasks;
+
+public static class Program
+{
+    public static void Main(string[] args)
+    {
+        new MyClass().Main();
+    }
+
+    public static void MethodAcceptingDelegate(Action action)
+    {
+        action();
+    }
+
+    public class MyClass
+    {
+        private string _str = "str";
+        private object _updateChartDataKey;
+
+        public void Main()
+        {
+            foreach (var q in MethodWithStateMachine())
+            {
+                Console.WriteLine("A");
+            }
+        }
+
+        public IEnumerable MethodWithStateMachine()
+        {
+            var updateChartDataKey = _updateChartDataKey = new { };
+            yield return 0;
+            Console.WriteLine("a");
+            if (updateChartDataKey == _updateChartDataKey)
+            {
+                MethodAcceptingDelegate(() => Console.WriteLine(_str));
+                yield return 1;
+            }
+        }
+    }
+}
\ No newline at end of file
diff --git a/Tests/SimpleTestCases/LambdaInStateMachine2_Issue544.cs b/Tests/SimpleTestCases/LambdaInStateMachine2_Issue544.cs
new file mode 100644
index 0000000..0f7a85f
--- /dev/null
+++ b/Tests/SimpleTestCases/LambdaInStateMachine2_Issue544.cs
@@ -0,0 +1,38 @@
+using System;
+using System.Threading.Tasks;
+
+public static class Program
+{
+    public static void Main(string[] args)
+    {
+        new MyClass().Main();
+    }
+
+    public static void MethodAcceptingDelegate(Action action)
+    {
+        action();
+    }
+
+    public class MyClass
+    {
+        private string _str = "str";
+        private object _updateChartDataKey;
+
+        public void Main()
+        {
+            var tcs = new TaskCompletionSource<object>();
+            tcs.TrySetResult(0);
+            MethodWithStateMachine(tcs.Task);
+        }
+
+        public async Task MethodWithStateMachine(Task t)
+        {
+            var updateChartDataKey = _updateChartDataKey = new { };
+            await t;
+            if (updateChartDataKey == _updateChartDataKey)
+            {
+                MethodAcceptingDelegate(() => Console.WriteLine(_str));
+            }
+        }
+    }
+}
\ No newline at end of file
diff --git a/Tests/SimpleTests.csproj b/Tests/SimpleTests.csproj
index 265627d..8e37e0b 100644
--- a/Tests/SimpleTests.csproj
+++ b/Tests/SimpleTests.csproj
@@ -379,6 +379,9 @@
     <None Include="SimpleTestCases\NullableModification_Issue361.cs" />
     <None Include="SimpleTestCases\NullableNullAccess.cs" />
     <None Include="SimpleTestCases\SignatureCacheDoubleGeneric_Issue547.cs" />
+    <None Include="SimpleTestCases\DelegateRemoveAdvancedWithLambda_Issue541.cs" />
+    <None Include="SimpleTestCases\LambdaInStateMachine1_Issue544.cs" />
+    <None Include="SimpleTestCases\LambdaInStateMachine2_Issue544.cs" />
   </ItemGroup>
   <ItemGroup>
     <ProjectReference Include="..\JSIL\JSIL.csproj">
-- 
1.9.3

